stages:
  - build
  - deploy

{% for source in task.sources %}

{% if source.type == 'python' %}
python-docs-build-{{ source.subpath }}-{{ source.ref }}:
  stage: build
  image: {{ images.docs }}
  script:
    - |
      if [ -d public/{{ source.subpath }} ]; then
          echo "using cached artifact"
          exit 0
      fi
    - git clone {{ source.repository }} target
    - cd target
    - git checkout {{ source.ref }}
    - cd {{ source.context|default('.') }}
{% for package in source.install|default([]) %}
    - pip install {{ package }}
{% endfor %}
    - mkdocs build -c -d ../public/{{ source.subpath }}
  artifacts:
    paths:
      - public/{{ source.subpath }}
  cache:
    key: "python-docs-build-{{ source.subpath }}-{{ source.ref }}"
    paths:
      - public/{{ source.subpath }}

{% endif %}

{% endfor %}

pages:
  stage: deploy
  needs:

{% for source in task.sources %}

{% if source.type == 'python' %}
    - python-docs-build-{{ source.subpath }}-{{ source.ref }}
{% endif %}

{% endfor %}

  script:
    - echo "noop"
  artifacts:
    paths:
      - public
