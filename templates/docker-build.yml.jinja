stages:
  - build
  - push

{% set docker_image = 'docker:26.0.2' %}

docker-build-{{ task.image }}:
  stage: build
  image: {{ docker_image }}
  script:
    - unset DOCKER_HOST
    - >-
        docker build
        -t {{ task.image }}
        -f {{ task.context|default('.') + '/' + task.file|default('Dockerfile') }}
        {{ task.context|default('.') }}

docker-push-{{ task.repository }}:
  stage: push
  needs:
    - docker-build-{{ task.image }}
  image: {{ docker_image }}
  script:
    - unset DOCKER_HOST
    - docker login $GITLAB_CR_REGISTRY -u $GITLAB_CR_USERNAME --password-stdin <<<$GITLAB_CR_PASSWORD 
    - docker tag {{ task.image }} {{ task.registry_section }}{{ task.image }}:latest
    - docker push {{ task.registry_section }}{{ task.image }}:latest
