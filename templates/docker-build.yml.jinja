stages:
  - build
  - push

docker-build-{{ task.image }}:
  stage: build
  image: {{ images.docker }}
  script:
    - >-
        {% if 'platforms' in task and len(task['platforms']) > 0 %}
        docker buildx build
        --platform {% ','.join(task['platforms']) %}
        --platform {% task['platforms'][0] %}
        {% else %}
        docker build --platform linux/amd64
        {% endif %}
        -t {{ task.image }}
        -f {{ task.file|default('Dockerfile') }}
        {{ task.context|default('.') }}


{% for registry in task.registries %}
{% for tag_source, tag  in helpers.get_tags(env).items() %}
docker-push:{{ registry }}:{{ tag }}:
  stage: push
  needs:
    - docker-build-{{ task.image }}
  image: {{ images.docker }}
  {% if helpers.should_use_manual_push(task, tag_source, env) %}
  when: manual
  {% endif %}
  script:
    {% if registry == 'gitlab' %}
    - echo "$GITLAB_CR_PASSWORD" | docker login $GITLAB_CR_REGISTRY -u $GITLAB_CR_USERNAME --password-stdin
    - docker tag {{ task.image }} {{ env.GITLAB_CR_REGISTRY}}/{{ task.image }}:{{ tag }}
    - docker push {{ env.GITLAB_CR_REGISTRY }}/{{ task.image }}:{{ tag }}
    {% elif registry == 'docker-hub' %}
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u $DOCKER_HUB_USERNAME --password-stdin
    - docker tag {{ task.image }} {{ env.DOCKER_HUB_REPOSITORY }}/{{ task.image }}:{{ tag }}
    - docker push {{ env.DOCKER_HUB_REPOSITORY }}/{{ task.image }}:{{ tag }}
    {% endif %}
{% endfor %}
{% endfor %}
