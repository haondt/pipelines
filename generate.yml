stages:
  - bootstrap

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always

generate:
  stage: bootstrap
  # image: registry.gitlab.com/haondt/cicd/registry/hephaestus:1.0.0
  script:
    - |
      if  [ ! -f pipeline.yml ]; then
        echo "Error: pipeline.yml not found"
        exit 1
      fi
    - apt update
    - apt install -y git python python3-venv
    - python3 -m venv ./venv
    - . ./venv/bin/activate
    - pip install PyYaml Jinja2
    - git clone https://gitlab.com/haondt/CICD/pipelines ./pipelines
    - cp pipeline.yml ./pipelines/
    - cd ./pipelines
    - echo "generating downstream pipeline"
    - python3 generate.py > ../generated_pipeline.yml
  artifacts:
    paths:
      - generated_pipeline.yml
    expire_in: 10 minutes

trigger:
  stage: bootstrap
  needs:
    - generate
  trigger:
    include:
      - artifact: generated_pipeline.yml
        job: generate
  variables:
    ROOT_PIPELINE_ID: $CI_PIPELINE_ID
